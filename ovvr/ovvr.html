<!doctype html>
<html>
<head>
    <title>OVVR</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <script src='http://abubujs.org/libs/Abubu.latest.js' 
	    type='text/javascript'></script>

    <link rel="stylesheet" type="text/css" href="abubu_app.css">
</head>


<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<!-- All shaders included here (codes written in GLSL)                 -->
<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->


<!-- ***************************************************************** -->
<script id='init1' type='x-shader-fragment'>#version 300 es
/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 * init1.frag   : initialize color-set 0 to 3
 *
 * PROGRAMMER   : ABOUZAR KABOUDIAN
 * DATE         : Tue 27 Oct 2020 18:52:54 (EDT)
 * PLACE        : Chaos Lab @ GaTech, Atlanta, GA
 *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 */
precision highp float ;
precision highp int ;


// interface variables ...................................................
in vec2 cc  ;

// variable macro ........................................................
#define aCaMK       color0.r
#define iCaMKfast   color0.g
#define iCaMKslow   color0.b
#define d           color0.a

#define ffast       color1.r
#define fslow       color1.g
#define fCafast     color1.b 
#define fCaslow     color1.a

#define jCa         color2.r
#define fCaMKfast   color2.g
#define fCaCaMKfast color2.b
#define n           color2.a

#define xrfast      color3.r
#define xrslow      color3.g
#define xs1         color3.b
#define xs2         color3.b

#define vlt         color4.r
#define V           color4.r
#define v           color4.g
#define xK1         color4.b
#define CaMKtrap    color4.a

#define Cansr       color5.r
#define Cajsr       color5.g
#define Cass        color5.b
#define Cai         color5.a 

#define Kss         color6.r
#define Ki          color6.g
#define Nass        color6.b
#define Nai         color6.a

#define m           color7.r
#define hfast       color7.g
#define hslow       color7.b
#define j           color7.a

#define hCaMKslow   color8.r
#define jCaMK       color8.g
#define mL          color8.b
#define hL          color8.a

#define JrelNP      color9.r
#define hLCaMK      color9.g


#define JrelCaMK    color10.r
#define sa          color10.g
#define ifast       color10.b
#define islow       color10.a

#define tvlt        color11.r


// color outputs .........................................................
layout (location = 0) out vec4 ocolor0 ; 
layout (location = 1) out vec4 ocolor1 ; 
layout (location = 2) out vec4 ocolor2 ; 
layout (location = 3) out vec4 ocolor3 ; 

/*========================================================================
 * main body of the shader
 *========================================================================
 */
void main(){
    // color declarations ................................................
    vec4 color0, color1, color2, color3,  color4, color5, 
         color6, color7, color8, color9, color10, color11 ;

    // color initializations .............................................
    aCaMK       = 0.000515567 ;
    iCaMKfast   = 0.9999542 ;
    iCaMKslow   = 0.641861 ;
    d           = 2.43015e-9 ;

    ffast       = 1.0 ;
    fslow       = 0.910671 ;
    fCafast     = 1.0 ;
    fCaslow     = 0.99982 ;
    
    xrfast      = 8.26608e-6 ;
    xrslow      = 0.453268  ;
    xs1         = 0.270492 ;
    xs2         = 0.0001963 ;

    // output color values ...............................................
    ocolor0 = vec4(color0) ;
    ocolor1 = vec4(color1) ;
    ocolor2 = vec4(color2) ;
    ocolor3 = vec4(color3) ;

    return ;
}


</script><!-- end of init1 shader's source code -->

<!-- ***************************************************************** -->
<script id='init2' type='x-shader-fragment'>#version 300 es
/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 * init2.frag   : initialize color-set 4 to 11
 *
 * PROGRAMMER   : ABOUZAR KABOUDIAN
 * DATE         : Tue 27 Oct 2020 18:52:14 (EDT)
 * PLACE        : Chaos Lab @ GaTech, Atlanta, GA
 *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 */

precision highp float ;
precision highp int ;


// interface variables ...................................................
in vec2 cc ;

// variable macro ........................................................
#define aCaMK       color0.r
#define iCaMKfast   color0.g
#define iCaMKslow   color0.b
#define d           color0.a

#define ffast       color1.r
#define fslow       color1.g
#define fCafast     color1.b 
#define fCaslow     color1.a

#define jCa         color2.r
#define fCaMKfast   color2.g
#define fCaCaMKfast color2.b
#define n           color2.a

#define xrfast      color3.r
#define xrslow      color3.g
#define xs1         color3.b
#define xs2         color3.b

#define vlt         color4.r
#define V           color4.r
#define v           color4.g
#define xK1         color4.b
#define CaMKtrap    color4.a

#define Cansr       color5.r
#define Cajsr       color5.g
#define Cass        color5.b
#define Cai         color5.a 

#define Kss         color6.r
#define Ki          color6.g
#define Nass        color6.b
#define Nai         color6.a

#define m           color7.r
#define hfast       color7.g
#define hslow       color7.b
#define j           color7.a

#define hCaMKslow   color8.r
#define jCaMK       color8.g
#define mL          color8.b
#define hL          color8.a

#define JrelNP      color9.r
#define hLCaMK      color9.g


#define JrelCaMK    color10.r
#define sa          color10.g
#define ifast       color10.b
#define islow       color10.a

#define tvlt        color11.r


// color outputs .........................................................
layout (location = 0) out vec4 ocolor4 ; 
layout (location = 1) out vec4 ocolor5 ; 
layout (location = 2) out vec4 ocolor6 ; 
layout (location = 3) out vec4 ocolor7 ; 
layout (location = 4) out vec4 ocolor8 ; 
layout (location = 5) out vec4 ocolor9 ; 
layout (location = 6) out vec4 ocolor10; 
layout (location = 7) out vec4 ocolor11; 

/*========================================================================
 * main body of the shader
 *========================================================================
 */
void main(){
    // color declarations ................................................
    vec4 color0, color1, color2, color3,  color4, color5, 
         color6, color7, color8, color9, color10, color11 ;

    // color initializations .............................................
    m           = 0.0074621 ;
    hfast       = 0.692591  ;
    hslow       = 0.692574  ;
    j           = 0.692477  ;

    hCaMKslow   = 0.448501    ;   
    jCaMK       = 0.692413    ;   
    mL          = 0.000194015 ;
    hL          = 0.496116    ;

    JrelNP      = 2.53943e-5  ;
    hLCaMK      = 0.265885   ;

    JrelCaMK    = 3.17262e-7 ;
    sa          = 0.00101185 ;
    ifast       = 0.999542   ;
    islow       = 0.589579   ;

    vlt         = -87.84 ;

    Cansr       = 1.61 ;  
    Cajsr       = 1.56 ;   
    Cass        = 8.43e-5 ;
    Cai         = 8.54e-5;

    Kss         = 143.79 ; 
    Ki          = 143.79 ;
    Nass        = 7.23   ; 
    Nai         = 7.23   ;

    tvlt        = vlt ;
    
    // output color values ...............................................
    ocolor4  = vec4( color4  ) ;
    ocolor5  = vec4( color5  ) ;
    ocolor6  = vec4( color6  ) ;
    ocolor7  = vec4( color7  ) ;
    ocolor8  = vec4( color8  ) ;
    ocolor9  = vec4( color9  ) ;
    ocolor10 = vec4( color10 ) ;
    ocolor11 = vec4( color11 ) ;

    return ;
}



</script><!-- end of init2 shader's source code -->

<!-- ***************************************************************** -->
<script id='comp1' type='x-shader-fragment'>#version 300 es
/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 * comp1.frag   : march color-set 0 to 3 for one time step
 *
 * PROGRAMMER   : ABOUZAR KABOUDIAN
 * DATE         : Tue 27 Oct 2020 18:52:54 (EDT)
 * PLACE        : Chaos Lab @ GaTech, Atlanta, GA
 *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 */
precision highp float ;
precision highp int ;


// interface variables ...................................................
in vec2 cc  ;
uniform sampler2D   
        icolor0, icolor1, icolor2, icolor3,  icolor4, icolor5, 
        icolor6, icolor7, icolor8, icolor9, icolor10, icolor11 ;

uniform float dt ;

// multipliers ...........................................................
/* time factor multipliers */
uniform float       Ct_m          ; 
uniform float       Ct_h          ; 
uniform float       Ct_j          ; 
uniform float       Ct_hCaMKslow  ; 
uniform float       Ct_hslow      ; 
uniform float       Ct_mL         ; 
uniform float       Ct_jCaMK      ; 
uniform float       Ct_hL         ; 
uniform float       Ct_hLCaMK     ; 
uniform float       Ct_a          ; 
uniform float       Ct_ifast      ; 
uniform float       Ct_islow      ; 
uniform float       Ct_aCaMK      ; 
uniform float       Ct_iCaMKfast  ; 
uniform float       Ct_iCaMKslow  ; 
uniform float       Ct_d          ; 
uniform float       Ct_ffast      ; 
uniform float       Ct_fslow      ; 
uniform float       Ct_fCafast    ; 
uniform float       Ct_fCaslow    ; 
uniform float       Ct_jCa        ; 
uniform float       Ct_fCaMKfast  ; 
uniform float       Ct_fCaCaMKfast; 
uniform float       Ct_n          ; 
uniform float       Ct_xrfast     ; 
uniform float       Ct_xrslow     ; 
uniform float       Ct_xs1        ; 
uniform float       Ct_xs2        ; 
uniform float       Ct_xk1        ; 
uniform float       Ct_relNP      ; 
uniform float       Ct_relCaMK    ; 
uniform float       Ct_tr         ; 
uniform float       Ct_diffCa     ; 
uniform float       Ct_diffNa     ; 
uniform float       Ct_diffK      ; 

/* current multipliers */
uniform float       C_Na        ;
uniform float       C_NaCa      ;
uniform float       C_to        ;
uniform float       C_CaL       ;
uniform float       C_CaNa      ;
uniform float       C_CaK       ;
uniform float       C_Kr        ;
uniform float       C_Ks        ;
uniform float       C_K1        ;
uniform float       C_NaCai     ;
uniform float       C_NaCass    ;
uniform float       C_NaKNa     ;
uniform float       C_NaKK      ;
uniform float       C_NaK       ;
uniform float       C_Nab       ;
uniform float       C_Kb        ;
uniform float       C_Cab       ;
uniform float       C_pCa       ;
uniform float       C_relNP     ;
uniform float       C_relCaMK   ;
uniform float       C_upNP      ;
uniform float       C_upCaMK    ;
uniform float       C_leak      ;
uniform float       C_up        ;
uniform float       C_tr        ;
uniform float       C_rel       ;
uniform float       C_diffCa    ;
uniform float       C_diffNa    ;
uniform float       C_diffK     ;


/* Scaling Factors          */
uniform float       SGNalate ;  
uniform float       SGto     ;  
uniform float       SPCa     ;  
uniform float       SGKr     ;  
uniform float       SGKs     ;  
uniform float       SGK1     ;  
uniform float       SGNaCa   ;  
uniform float       SGNaK    ;  
uniform float       SGKb     ;  
uniform float       SJrel    ;  
uniform float       SJup     ;  
uniform float       SCMDN    ;


uniform int         cellType ;


// variable macro ........................................................
#define aCaMK       color0.r
#define iCaMKfast   color0.g
#define iCaMKslow   color0.b
#define d           color0.a

#define ffast       color1.r
#define fslow       color1.g
#define fCafast     color1.b 
#define fCaslow     color1.a

#define jCa         color2.r
#define fCaMKfast   color2.g
#define fCaCaMKfast color2.b
#define n           color2.a

#define xrfast      color3.r
#define xrslow      color3.g
#define xs1         color3.b
#define xs2         color3.b

#define vlt         color4.r
#define V           color4.r
#define v           color4.g
#define xK1         color4.b
#define CaMKtrap    color4.a

#define Cansr       color5.r
#define Cajsr       color5.g
#define Cass        color5.b
#define Cai         color5.a 

#define Kss         color6.r
#define Ki          color6.g
#define Nass        color6.b
#define Nai         color6.a

#define m           color7.r
#define hfast       color7.g
#define hslow       color7.b
#define j           color7.a

#define hCaMKslow   color8.r
#define jCaMK       color8.g
#define mL          color8.b
#define hL          color8.a

#define JrelNP      color9.r
#define hLCaMK      color9.g


#define JrelCaMK    color10.r
#define sa          color10.g
#define ifast       color10.b
#define islow       color10.a

#define tvlt        color11.r


// color outputs .........................................................
layout (location = 0) out vec4 ocolor0 ; 
layout (location = 1) out vec4 ocolor1 ; 
layout (location = 2) out vec4 ocolor2 ; 
layout (location = 3) out vec4 ocolor3 ; 


/*========================================================================
 * RL1  : Rush Larsen 1: works with y_inf and tau_y
 *      dy/dt = (y_inf - y)/tau_y where
 *========================================================================
 */
float RL1(float yo, float y_inf, float tau_inf,float deltaT){
    return y_inf + (yo - y_inf)*exp(-deltaT/tau_inf) ; 
}

/*========================================================================
 * RL2 : Rush Larsen 2: works with a and b values 
 *      dy/dt = (y_inf - y)/tau_y where
 *      y_inf = a/(a+b)     and      tau_y = 1./(a+b)
 *========================================================================
 */
float RL2(float yo, float a, float b,float deltaT){
    float y_inf = a/(a+b) ;
    float t_inf = 1./(a+b) ;

    return RL1(yo,y_inf,t_inf,deltaT) ; 
}


/*========================================================================
 * main body of the shader
 *========================================================================
 */
void main(){
    // localizing variables ..............................................
    vec4 color0  = texture( icolor0  , cc ) ;
    vec4 color1  = texture( icolor1  , cc ) ;
    vec4 color2  = texture( icolor2  , cc ) ;
    vec4 color3  = texture( icolor3  , cc ) ;
    vec4 color4  = texture( icolor4  , cc ) ;
    vec4 color5  = texture( icolor5  , cc ) ;
    vec4 color6  = texture( icolor6  , cc ) ;
    vec4 color7  = texture( icolor7  , cc ) ;
    vec4 color8  = texture( icolor8  , cc ) ;
    vec4 color9  = texture( icolor9  , cc ) ;
    vec4 color10 = texture( icolor10 , cc ) ;
    vec4 color11 = texture( icolor11 , cc ) ;

    // aCaMK .............................................................
    float   aCaMKinf = 1./
            (   1. +    exp(  -(V-24.34)/14.82 )           ) ;

    float   ta       = 1.0515/
            (   1./ (   1.2089*(1.+exp(-(V-18.41)/29.38))  ) +
                3.5/(   1. + exp(  (V+100.)/29.38  )   )   ) ;

    ta *= Ct_aCaMK ;

    aCaMK = RL1( aCaMK, aCaMKinf, ta, dt ) ;

    // iCaMKfast, iCaMKslow ..............................................
    float   iCaMKinf = 1./
            (   1. + exp(   (V+43.94)/5.711    )           ) ;

    float   dCaMKdev = 1.354 + 1.0e-4/
            (   exp(           (V-167.4)/15.89     ) +
                exp(          -(V-12.23)/0.2145    )       ) ;

    float   dCaMKrec = 1.0 - 0.5/
            (   1. +    exp(   (V+70.)/20.0        )       ) ;

    float   tifast   = 4.562 + 1./
            (   0.3933*exp(-(V+100.)/100.  ) +
                0.08004*exp((V+50.0)/16.59 )               ) ;


    float   tislow   = 23.62 +
            1./( 0.001416*exp(-(V+96.52)/59.05 )
                +1.7808e-8*exp((V+114.1)/8.079 )           ) ;
    float   tiCaMKfast = tifast*dCaMKdev*dCaMKrec*Ct_iCaMKfast ;
    float   tiCaMKslow = tislow*dCaMKdev*dCaMKrec*Ct_iCaMKslow ;

    iCaMKfast = RL1( iCaMKfast, aCaMKinf, tiCaMKfast, dt ) ;
    iCaMKslow = RL1( iCaMKslow, aCaMKinf, tiCaMKslow, dt ) ;

    // d .................................................................
    float   dinf = 1./
            (   1. +    exp(   -(V+3.940)/4.230    )       ) ;

    float   td   =  0.6 + 1./
            (   exp(   -0.05*(V+6.0)               ) +
                exp(    0.09*(V+14.0)              )       ) ;
    td *= Ct_d ;
    
    d = RL1(d, dinf, td, dt ) ;

    // ffast, fslow ......................................................
    float   finf    =  1./
            (   1. + exp(      (V+19.58)/3.696     )       ) ;

    float   tffast  =  7.0 + 1./
            (   0.0045*exp(   -(V+20.0)/10.0       ) +
                0.0045*exp(    (V+20.0)/10.0       )       ) ;
    tffast *= Ct_ffast ;

    float   tfslow  = 1000.0 +
                1./(    0.000035*exp(-(V+5.0)/4.0 ) +
                        0.000035*exp( (V+5.0)/6.0 )        ) ;
    tfslow *= Ct_fslow ;

    ffast = RL1( ffast , finf, tffast, dt ) ;
    fslow = RL1( fslow , finf, tfslow, dt ) ;

    // fCafast, fCaslow ..................................................
    float   fCainf   = finf ;
    float   tfCafast = 7.0 +
                1./(    0.04*exp( -(V-4.0)/7.0)    +
                        0.04*exp(  (V-4.0)/7.0)            ) ;
    tfCafast *= Ct_fCafast ;

    float   tfCaslow = 100.0 +
                1./(    0.00012*exp( -V/3.0 ) +
                        0.00012*exp(  V/7.0 )              ) ;
    tfCaslow *= Ct_fCaslow ;
    
    fCafast = RL1( fCafast, fCainf, tfCafast, dt ) ;
    fCaslow = RL1( fCaslow, fCainf, tfCaslow, dt ) ;

    // jCa ...............................................................
    float   jCainf  =  1./
            (   1. + exp(      (V+19.58)/3.696     )       ) ;

    float   tjCa    = 75.0*Ct_jCa ;
    
    jCa = RL1( jCa, jCainf, tjCa, dt ) ;

    // fCaMKfast .........................................................
    float   fCaMKinf = jCainf ;

    float   tfCaCMfast = 7.0 + 1./
            (   0.0045*exp(   -(V+20.0)/10.0       ) +
                0.0045*exp(    (V+20.0)/10.0       )       ) ;
    tfCaCMfast *= 2.5*Ct_fCaMKfast ;

    fCaMKfast = RL1(fCaMKfast, fCaMKinf, tfCaCMfast, dt ) ;

    // fCaCaMKfast .......................................................
    float   fCaCaMKinf = jCainf ;

    float   tfCaCaMKfast = 7.0 + 1./
            (   0.0045*exp(   -(V+20.0)/10.0       ) +
                0.0045*exp(    (V+20.0)/10.0       )       ) ;
    tfCaCaMKfast *=  2.5*2.5*Ct_fCaCaMKfast ;

    tfCaCaMKfast = RL1( tfCaCaMKfast, fCaCaMKinf, tfCaCaMKfast, dt ) ; 
    
    // n .................................................................
    float Kmn  = 0.002 ; float kp2n = 1000.0 ; float km2n = jCa ;
    Cass = Cajsr ;

    float kappa     = 1. + Kmn/Cass ;
    kappa           = kappa*kappa*kappa*kappa ;

    float alpha_n   = 1.0 /( kp2n/km2n  + kappa ) ;
    float ninf      = alpha_n*kp2n/km2n ;
    float tn        = Ct_n/km2n ;
    
    n = RL1( n, ninf, tn, dt ) ;

    // xrfast, xrslow ....................................................
    float   xrinf   = 1./
            (   1.  +   exp(   -(V+8.337)/6.789    )       ) ;

    float   txrfast  = (
             12.98 + 1./
            (   0.3652*exp(     (V-31.66)/3.869    ) +
                4.123e-5*exp(  -(V-47.78)/20.38    )       )
        )*Ct_xrfast ;

    float   txrslow  = (
                1.865 + 1./
            (   0.06629*exp(    (V-34.70)/7.355    ) +
                1.128e-5*exp(   (29.74-V)/25.94    )       ) 
        ) * Ct_xrslow ;

    xrfast = RL1( xrfast, xrinf, txrfast, dt ) ;
    xrslow = RL1( xrslow, xrinf, txrslow, dt ) ;

    // xs1, xs2 ..........................................................
    float   xs1inf  = 1./
            (   1. +    exp(   -(V+11.60)/8.932    )       ) ;

    float   xs2inf  = xs1inf ;
    float   txs1    = (
             817.3 + 1./
            (   2.326e-4*exp(   (V+48.28)/17.80    ) +
                0.001292*exp(  -(V+210.0)/230.0    )       )
        ) * Ct_xs1 ;
    float   txs2    = (
             1./
            (   0.01*exp(       (V-50.0)/20.0      ) +
                0.0193*exp(    -(V+66.54)/31.      )       ) 
        ) * Ct_xs2 ;

    xs1 = RL1( xs1, xs1inf, txs1, dt ) ;
    xs2 = RL1( xs2, xs2inf, txs2, dt ) ;
    
    
    // output color values ...............................................
    ocolor0 = vec4(color0) ;
    ocolor1 = vec4(color1) ;
    ocolor2 = vec4(color2) ;
    ocolor3 = vec4(color3) ;
}


</script><!-- end of comp1 shader's source code -->

<!-- ***************************************************************** -->
<script id='comp2' type='x-shader-fragment'>

</script><!-- end of comp2 shader's source code -->

<!-- ***************************************************************** -->
<script id='click' type='x-shader-fragment'>#version 300 es
precision highp float ;
precision highp int ;

uniform sampler2D   inTexture ;
uniform vec2        clickPosition ;
uniform float       clickRadius ;

in vec2 cc, pixPos ;

layout (location = 0) out vec4 ocolor ;

#define u       color.r
// Main body of the shader
void main() {
    vec2  size  = vec2(textureSize(inTexture, 0)) ;

    // read the color of the pixel .......................................
    vec4 color = texture( inTexture , cc ) ;
 
    if ( length(clickPosition - cc )< clickRadius ){
        u = 1. ;
    }

    // output the color of the pixel .....................................
    ocolor = color ;
    return ;
}



</script><!-- end of click shader's source code -->

<!-- ***************************************************************** -->
<script id='display' type='x-shader-fragment'>#version 300 es
/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 * display.frag : calculate the colors for the various regions of
 * activation
 *
 * PROGRAMMER   : ABOUZAR KABOUDIAN
 * DATE         : Mon 19 Oct 2020 14:23:21 (EDT)
 * PLACE        : Chaos Lab @ GaTech, Atlanta, GA
 *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 */
precision highp float ;
precision highp int ;

// interface variables ---------------------------------------------------
in vec2 cc ;
uniform sampler2D   inColor ;
uniform float       uThreshold, vThreshold ;
uniform float       thickness ;

layout (location=0) out vec4 ocolor ;

// macros ----------------------------------------------------------------
#define ut  uThreshold
#define vt  vThreshold

#define u   color.r
#define v   color.g

/*========================================================================
 * main body 
 *========================================================================
 */
void main(){
    vec4 color = texture(inColor , cc ) ;

    float f = (u>ut) ? 1. : 0. ;
    float g = (v<vt) ? 1. : 0. ;

    ocolor = vec4(f,g,0.,1.) ;

    return ;
}


</script><!-- end of display shader's source code -->

<!-- ***************************************************************** -->
<script id='defib' type='x-shader-fragment'>#version 300 es
/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 * defib.frag   : Defibrillation shader
 *
 * PROGRAMMER   : ABOUZAR KABOUDIAN
 * DATE         : Mon 19 Oct 2020 14:18:47 (EDT)
 * PLACE        : Chaos Lab @ GaTech, Atlanta, GA
 *@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
 */
precision highp float ;
precision highp int ;

// interface variables ---------------------------------------------------
in vec2 cc ;
uniform sampler2D   inColor ;
uniform float uThreshold, vThreshold ;
uniform float thickness ;

layout (location=0) out vec4 ocolor ;

// macros ----------------------------------------------------------------

#define ut  uThreshold
#define vt  vThreshold

#define u   color.r
#define v   color.g

#define noThetaDivs 20.

/*========================================================================
 * main body
 *========================================================================
 */
void main(){
    vec4 color = texture(inColor , cc ) ;
    vec4 col ;

    float f = (u>ut) ? 1. : -1. ;
    float g = (v<vt) ? 1. : -1. ;
    
    float pi = acos(-1.) ;
    vec2  dir ;
    float theta ;

    if (f<0. && g<0. ){
        // search around the point to see if the point is in the region
        // which requires stimulation
        for(float i=0. ; i<noThetaDivs ;i+=1.){
            theta = 2.*i*pi/noThetaDivs ;
            dir = thickness*vec2(cos(theta),sin(theta)) ;
            col = texture(inColor, cc + dir ) ;

            if ( (((col.g<vt) ? 1. : -1.) *g) < 0. ){
                u = 1. ;
                break ;
            }
        }
    }
    
    ocolor = vec4(color) ;
    return ;
}


</script><!-- end of defib shader's source code -->



<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<!-- main script - JavaScript code                                     -->
<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<script>
/*========================================================================
 * get the source code for fragment shaders
 *========================================================================
 */
function source( id ){
    return document.getElementById( id ).innerHTML ;
}
var env = {} ; // Global variable

/*========================================================================
 * loadWebGL code
 *========================================================================
 */ 
function loadWebGL(){
    env.width  = 512 ;
    env.height = 512 ;
    env.time   = 0. ;

/*------------------------------------------------------------------------
 * creating textures for time stepping 
 *------------------------------------------------------------------------
 */
    env.fcolors = [] ;
    env.scolors = [] ;
    for(var i=0; i<12; i++){
        env['fcolor'+i] = new Abubu.Float32Texture( 
                env.width, env.height, { pairable : true } ) ;
        env['scolor'+i] = new Abubu.Float32Texture( 
                env.width, env.height, { pairable : true } ) ;
        env.fcolors.push(env['fcolor'+i]) ;
        env.scolors.push(env['scolor'+i]) ;
    }
    env.colors = [ ...env.fcolors, ...env.scolors ] ;
    for(var i=0; i< env.colors.length ; i++){
        env.colors[i].pairable = true ;
    }

    function OvvrTargets1( colors ){
        this.ocolor0    = { location : 0 , target : colors[0] } ;
        this.ocolor1    = { location : 1 , target : colors[1] } ;
        this.ocolor2    = { location : 2 , target : colors[2] } ;
        this.ocolor3    = { location : 3 , target : colors[3] } ;
    }

    function OvvrTargets2( colors ){
        this.ocolor4    = { location : 0 , target : colors[4] } ;
        this.ocolor5    = { location : 1 , target : colors[5] } ;
        this.ocolor6    = { location : 2 , target : colors[6] } ;
        this.ocolor7    = { location : 3 , target : colors[7] } ;
        this.ocolor8    = { location : 4 , target : colors[8] } ;
        this.ocolor9    = { location : 5 , target : colors[9] } ;
        this.ocolor10   = { location : 6 , target : colors[10] } ;
        this.ocolor11   = { location : 7 , target : colors[11] } ;
    }

/*------------------------------------------------------------------------
 * Initial conditions  
 *------------------------------------------------------------------------
 */
    // init sets 0 to 3 ..................................................
    env.finit1 = new Abubu.Solver({
        fragmentShader : source( 'init1' ) ,
        targets : new OvvrTargets1( env.fcolors ) ,
    } ) ;
    env.sinit1 = new Abubu.Solver({
        fragmentShader : source( 'init1' ) ,
        targets : new OvvrTargets1( env.scolors ) ,
    } ) ;

    // init sets 4 to 11 .................................................
    env.finit2 = new Abubu.Solver({
        fragmentShader : source( 'init2' ) ,
        targets : new OvvrTargets2( env.fcolors ) ,
    } ) ;
    env.sinit2 = new Abubu.Solver({
        fragmentShader : source( 'init2' ) ,
        targets : new OvvrTargets2( env.scolors ) ,
    } ) ;

    // function to initialize solution ...................................
    env.initialize = function(){
        env.finit1.run() ;
        env.sinit1.run() ;
        
        env.finit2.run() ;
        env.sinit2.run() ;


        env.splot.init() ;
        env.vsgn.init(0) ;
        env.osgn.init(0) ;

        env.time = 0. ;
    }

/*------------------------------------------------------------------------
 * marching steps 
 *------------------------------------------------------------------------
 */
    env.fcomp1 = new Abubu.Solver({
        fragmentShader : source('comp1') ,
        targets : new OvvrTargets1( env.scolors ) ,
    } ) ;
//
//    // reads fcolors and writes scolors ..................................
//    env.fcomp = new Abubu.Solver({
//        fragmentShader : source('comp') ,
//        uniforms : new compUniforms( env.fcolors ) ,
//        targets : new TpTargets( env.scolors ) ,
//    } ) ;
//
//    // reads scolors and writes fcolors ..................................
//    env.scomp = new Abubu.Solver({
//        fragmentShader : source('comp') ,
//        uniforms : new compUniforms( env.scolors ) ,
//        targets : new TpTargets( env.fcolors ) ,
//    } ) ;

    // marches the solution for two time steps ...........................
    env.march = function(){
        //env.fcomp.render() ;
        //env.scomp.render() ;
        env.time += 2.*env.dt ;
    } ;

/*------------------------------------------------------------------------
 * click to excite 
 *------------------------------------------------------------------------
 */
    var click = new Abubu.Solver({
        fragmentShader : source( 'click' ) ,
        uniforms : {
            inTexture       : { type : 't', value  : env.fcolor4    } ,
            clickRadius     : { type : 'f', value  : 0.1            } ,
            clickPosition   : { type : 'v2', value : [0.5,0.5]      } ,
        } ,
        targets : {
            ocolor : { location : 0 , target : env.scolor1 } ,
        }
    } ) ;
    
    var clickCopy = new Abubu.Copy( env.scolor1, env.fcolor4 ) ;
    
    var mouseDrag_1 = new Abubu.MouseListener({
        canvas : document.getElementById('canvas_1') ,
        event : 'drag' ,
        callback : function(e){
            click.uniforms.clickPosition.value = e.position ;
            click.render() ;
            clickCopy.render() ;
        }
    } ) ; 

    var mouseDrag_2 = new Abubu.MouseListener({
        canvas : document.getElementById('canvas_3') ,
        event : 'drag' ,
        callback : function(e){
            click.uniforms.clickPosition.value = e.position ;
            click.render() ;
            clickCopy.render() ;
        }
    } ) ; 

/*------------------------------------------------------------------------
 * defibrilate 
 *------------------------------------------------------------------------
 */
    env.defib = {} ;
    env.thickness  = 0.05 ;
    env.uThreshold = -20 ;
    env.vThreshold = 0.25 ;

    env.defib_s1 = new Abubu.Solver({
        fragmentShader : source('defib') ,
        uniforms :{
            inColor : { type : 's', value : env.fcolor4, 
                        magFilter: 'linear' } ,
            thickness  : { type : 'f', value : env.thickness   } ,
            uThreshold : { type : 'f', value : env.uThreshold  } ,
            vThreshold : { type : 'f', value : env.vThreshold  } ,
        } ,
        targets : {
            ocolor : { location : 0 , target : env.scolor4 } ,
        }
    } ) ;
    
    env.defib_s2 = new Abubu.Copy(env.scolor4, env.fcolor4) ;
    env.defibrillate = function(){
        env.defib_s1.render() ;
        env.defib_s2.render() ;
    }
/*------------------------------------------------------------------------
 * save and load file 
 *------------------------------------------------------------------------
 */

    // save file .........................................................
    env.csvFileName = 'colorsSets_0_4.csv' ;
    env.saveCsvFile = function(){
        var link = document.createElement('a') ;
        var data = "data:text;charset=utf-8," +
            env.fcolor0.width + ',' + 
            env.fcolor0.height ;
        var width = env.fcolor0.width ;
        var height = env.fcolor0.height ;
        var f0 = env.fcolor0.value ;
        var f1 = env.fcolor1.value ;
        var f2 = env.fcolor2.value ;
        var f3 = env.fcolor3.value ;
        var f4 = env.fcolor4.value ;

        for(var i=0 ; i<(width*height) ; i++){
            var indx = i*4 ;
            data += ','+ 
                f0[indx  ].toExponential()+ ',' +
                f0[indx+1].toExponential()+ ',' +
                f0[indx+2].toExponential()+ ',' +
                f0[indx+3].toExponential()+ ',' +
                f1[indx  ].toExponential()+ ',' +
                f1[indx+1].toExponential()+ ',' +
                f1[indx+2].toExponential()+ ',' +
                f1[indx+3].toExponential()+ ',' +
                f2[indx  ].toExponential()+ ',' +
                f2[indx+1].toExponential()+ ',' +
                f2[indx+2].toExponential()+ ',' +
                f2[indx+3].toExponential()+ ',' +
                f3[indx  ].toExponential()+ ',' +
                f3[indx+1].toExponential()+ ',' +
                f3[indx+2].toExponential()+ ',' +
                f3[indx+3].toExponential()+ ',' +
                f4[indx  ].toExponential()+ ',' +
                f4[indx+1].toExponential()+ ',' +
                f4[indx+2].toExponential()+ ',' +
                f4[indx+3].toExponential() ;
        }
        
        var csv = encodeURI( data ) ;
        link.setAttribute( 'href', csv ) ;
        link.setAttribute( 'download', env.csvFileName ) ;
        link.click() ;
    }

    // load file .........................................................
    env.loadCsvFile = document.createElement('input') ;
    env.loadCsvFile.setAttribute('type', 'file') ;
    env.loadCsvFile.onchange = function(){
        /* check if a no file was selected */
        if ( !env.loadCsvFile.files[0] ){        
            return ;
        } ;
    
        var file = env.loadCsvFile.files[0] ;
        var reader = new FileReader() ;
        reader.readAsText(file) ;
    
        // only the when the file is loaded it can be analyzed
        reader.onload = function(event){
            var result  = event.target.result ;
            var data = result.split(',') ;
    
            var width = parseInt(data[0]) ;
            var height = parseInt(data[1]) ;
    
            var tabs = [] ;
            for(var i = 0 ; i<5 ; i++){
                tabs.push( new Float32Array(width*height*4) ) ;
            }
            
            var p = 2 ;
            var indx ;

            for (var i=0 ; i< (width*height) ; i++){ // modify accordingly
                indx = i*4 ;
                for(var j=0 ; j< 5 ; j++){
                    tabs[j][ indx   ] = parseFloat( data[p++]) ;
                    tabs[j][ indx+1 ] = parseFloat( data[p++]) ;
                    tabs[j][ indx+2 ] = parseFloat( data[p++]) ;
                    tabs[j][ indx+3 ] = parseFloat( data[p++]) ;
                }
             }

            for( var j=0 ; j<5; j++){
                env.fcolors[j].data = tabs[j] ;
                env.scolors[j].data = tabs[j] ;
            }
        }
    }
    
/*------------------------------------------------------------------------
 * Postprocessing 
 *------------------------------------------------------------------------
 */
    // voltage plot ------------------------------------------------------
    env.vplot = new Abubu.Plot2D({
        target : env.fcolor4 ,
        channel: 'r' ,
        minValue : -90 ,
        maxValue : 30 ,
        colorbar : true ,
        canvas : document.getElementById('canvas_1') ,
    } ) ;
    env.vplot.init() ;

    // tplot -------------------------------------------------------------
    env.tplot = new Abubu.Solver({
        fragmentShader : source("display") ,
        uniforms : {
            inColor : { type : 't', value : env.fcolor4 } ,
            thickness  : { type : 'f', value : env.thickness   } ,
            uThreshold : { type : 'f', value : env.uThreshold  } ,
            vThreshold : { type : 'f', value : env.vThreshold  } ,
        } ,
        canvas :  document.getElementById('canvas_3') 
    } ) ;

    // signal plots ------------------------------------------------------
    env.splot = new Abubu.SignalPlot({
        noPltPoints : 1024, // number of sample points
        grid : 'on', 
        nx   : 10 , // number of division in x 
        ny   : 12 , // ... in y 

        xticks : {  mode : 'auto', unit : 'ms', font : '11pt Times' } ,
        yticks : {  mode : 'auto', unit : '' , 
                    font : '12pt Times',precision : 1  } ,
        canvas : document.getElementById('canvas_2') 
    } ) ;

    env.osgn = env.splot.addSignal( env.fcolor4, {
            channel : 'g',
            minValue : -.1,
            maxValue : 1.1 ,
            restValue : 0. ,
            color : [ 0.3,0.,0.0 ],
            visible : true ,
            timewindow : 1000 , 
            probePosition : [0.5,0.5] 
    } ) ;

    // voltage signal ....................................................
    env.vsgn = env.splot.addSignal( env.fcolor4, {
            channel : 'r',
            minValue : -90,
            maxValue : 30 ,
            restValue : -83.0 ,
            color : [ 0.,.4,0.0 ],
            visible : true ,
            timewindow : 1000 , 
            probePosition : [0.5,0.5] 
    } ) ;


    // updateSignals -----------------------------------------------------
    env.updateSignals= function(){
        env.vsgn.update(env.time) ;
        env.osgn.update(env.time) ;
    }

    // refreshDisplay ----------------------------------------------------
    env.refreshDisplay = function(){
        env.vplot.render() ;
        env.splot.render() ;
        env.tplot.render() ;
    }

/*------------------------------------------------------------------------
 * Run sequence
 *------------------------------------------------------------------------
 */
    env.skip = 30 ;
    env.running = false ;
    env.run = function(){
        if (env.running){
            for(var i = 0 ; i<env.skip ; i++){
                env.march() ;
                env.updateSignals() ; 
            }
        }
        env.refreshDisplay() ;
        requestAnimationFrame(env.run) ;
    }

    createGui() ;
    env.initialize() ;
    env.run() ;
}

/*========================================================================
 * add multiple parameters to the GUI
 *========================================================================
 */ 
function addToGui( 
        guiElemenent ,  // gui element to add options into
        obj,            // object that holds parameters
        paramList,      // array of strings that contains list 
                        // of parmeters to be added
        solverList      // array of solvers that need to be update upon 
                        // change of a parameter through gui interactions
    ){
    var elements = {} ;
    for(i in paramList){
        var param = paramList[i] ;
        elements[param] = guiElemenent.add(obj, param )  ;
        elements[param].onChange(function(){
            console.log(this) ;
            Abubu.setUniformInSolvers( 
                    this.property , // this refers to the GUI element 
                    this.object[this.property] , 
                    solverList ) ;
        } ) ;
    }
    return elements ;
}

/*========================================================================
 * createGui
 *========================================================================
 */ 
function createGui(){
    var gui = new Abubu.Gui() ;     /*  create a graphical user 
                                        interface               */
    var panel = gui.addPanel() ;    /*  add a panel to the GUI  */

    // model parameters ..................................................
    var mdl = panel.addFolder("Model Parameters") ;
    addToGui(mdl, env,[ ], [env.fcomp, env.scomp] ) ;

    // defibrilation -----------------------------------------------------
    var dfb = panel.addFolder("Defibrillation") ;
    dfb.elements = addToGui( dfb, env, 
        [
            "thickness" ,
            "uThreshold" ,
            "vThreshold" 
        ] , [ env.defib_s1, env.tplot ] ) ;
   
    dfb.add(env,'defibrillate') ;
    dfb.open() ;
    
    // csv files ---------------------------------------------------------
    var csv = panel.addFolder('Save and Load CSV') ;
    csv.add(env,'csvFileName' ) ;
    csv.add(env,'saveCsvFile' ) ;
    csv.add(env.loadCsvFile , 'click').name('loadCsvFile') ;

    // execution .........................................................
    var exe = panel.addFolder('Execution') ;
    exe.add(env,'time').listen() ;
    exe.add(env,'skip') ;
    exe.add(env,'initialize') ;
    exe.add(env,'running') ;
    exe.open() ;
}

</script>

<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<!-- body of the html page                                             -->
<!--&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&-->
<body onload='loadWebGL();'>
    <h1>The OVVR Model</h1>
    <canvas id='canvas_1' width=512 height=512>
        Your browser does not support HTML4.0 canvas elements.
    </canvas>
    <canvas id='canvas_3' width=512 height=512>
        Your browser does not support HTML4.0 canvas elements.
    </canvas>
    <canvas id='canvas_2' width=512 height=512>
        Your browser does not support HTML4.0 canvas elements.
    </canvas>

</body>
</html>
